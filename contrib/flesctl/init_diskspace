#!/bin/bash

set -e  # stop on error
set -u  # ensure variables are defined

# global parameters, may be overwritten by environment
: ${SCRIPT_DIR:=~/}
: ${SPM_CFG:=/scratch/diskspace.spm}

# command line parameters
if [ "$#" -ne 1 ]; then
  echo "Usage: $0 <nodes_list>"
  exit 1
fi

NODES_LIST="$1"

###############################################################

# read node list into bash array
declare -a PN_LIST
ARCH_LIST=(`scontrol show hostname "$NODES_LIST"`)

echo -n "Generating disk space printout configs for "
echo "${ARCH_LIST[*]}"

echo "Writing output to $SPM_CFG"

# processing nodes
declare -a ARCH_SPM
output=0
for node in ${ARCH_LIST[@]}; do
    # hostconfig $node <= PAL, 28/05/2021, Not sure what it does?
    ARCH_SPM+=("$node: bash -c '${SCRIPT_DIR}moni_ssd_may2021.sh'")
    ((output += 1))
done


# generate output
echo -e "# SPM configuration autogenerated at `date`" > $SPM_CFG

echo -e "\n# Processing nodes" >> $SPM_CFG
for i in ${!ARCH_SPM[*]}; do
   echo ${ARCH_SPM[$i]} >> $SPM_CFG
done
