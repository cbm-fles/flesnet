#!/bin/bash

set -e  # stop on error
set -u  # ensure variables are defined

# global parameters, may be overwritten by environment
: ${SPMDIR:=/opt/spm/}
: ${RUNDIR:=}
: ${LOGDIR:=log/}
: ${SPM_CFG:=${RUNDIR}copyblock.spm}

# command line parameters
if [ "$#" -ne 2 ]; then
  echo "Usage: $0 <nodes_list> <run_id>"
  exit 1
fi

NODES_LIST="$1"
RUN_ID="$2"

###############################################################

# read node list into bash array
declare -a PN_LIST
ARCH_LIST=(`scontrol show hostname "$NODES_LIST"`)

echo -n "Generating copyblock configs for "
echo "${ARCH_LIST[*]}"

echo "Writing output to $SPM_CFG"

# processing nodes
declare -a ARCH_SPM
output=0
for node in ${ARCH_LIST[@]}; do
    # hostconfig $node <= PAL, 28/05/2021, Not sure what it does?
    ARCH_SPM+=("$node: bash -c 'while true; do sleep 10; done'")
    ((output += 1))
done


# generate output
echo -e "# SPM configuration autogenerated at `date`" > $SPM_CFG

echo -e "\n# Processing nodes" >> $SPM_CFG
for i in ${!ARCH_SPM[*]}; do
   echo ${ARCH_SPM[$i]} >> $SPM_CFG
done

