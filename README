FLESnet usage for FLIB stand alone readout
==========================================

NOTE the new FAQ section at the end of the document!

FLESnet:
--------

cd build
./flesnet --help
cp ../contrib/flesnet_flib_example.cfg ./flesnet.cfg

modify flesnet.cfg:
 - choose 'processor-executable' ,e.g. to store data

Usage:
Start flib_ctrl to configure FLIB before starting flesnet!
Flesnet will automatically read all activated FLIB links.

./flesnet


NOTE: In case flesnet crashed, exited with an exception, was stopped
or is just not working you might need to cleanup some things.
See the FAQs for the cleanup procedure.

FLIB Control:
-------------

cd build
./flib_ctrl --help
cp ../contrib/flib.cfg ./flib.cfg

modify flib.cfg:
 - Set the data source for each FLIB link.
   For reading from the optical link use 'link'.
   Note: link 0 is the link closest to the PCIe connector.
 - Set links you do not intend to use to 'disable'.
 - If reading from a optical link you need to provide
   sys_id and sys_ver of the connected source.

The provided example flib.cfg will read 4 FLIB links with
patten generator and a Microslice size of 10 Âµs.

Usage:
./flib_ctrl

Do not start/stop while flesnet is running!

If link is selected as data source it is mandatory to provide 
the subsystem identifier and the subsystem format version
of the connected component. For all other data sources this is
configured automatically. This information can be used to 
determine which analysis code is called later on.

Defined subsystem identifiers are:
Silicon Tracking System (STS) 		0x10 
Micro-Vertex Detector (MVD) 		0x20 
Ring Imaging CHerenkov detector (RICH) 	0x30 
Transition Radiation Detector (TRD) 	0x40 
Muon Chamber system (MuCh) 		0x50 
Resistive Plate Chambers (RPC) 		0x60 
Electromagnetic CALorimeter (ECAL) 	0x70 
Projectile Spectator Detector (PSD) 	0x80
FLIB hardware pattern generator		0xF0
FLIB front end emulation		0xF1
Flesnet software pattern generator	0xFA

Control Client:
---------------

cd ctrl
source config.sh
cd control/cliclient
./cliclient -help

Example: send DLM 0x8 over flib link 0 to nodeid 0x1.
./cliclient localhost:9750 dlm 0x1 0x8

General:
--------

SIMPATH has to point to a fairroot external packages installation


Preparing the FLIB
==================

Download a bitfile from the build server
----------------------------------------

run, e.g.:

curl -O -u <GSI web login user> https://cbm-firmware.gsi.de/result/XX/flib_cnet_readout/XXX/htg_k7_cnet_readout.bit

(NOTE: failing to provide a valid user/password won't give an error
but result in an unuseable file.)

Programming the FPGA
--------------------

cp contrib/flib-reprogramm to a location in your path and adopt settings.
Add full path to impcat, do not source Xilinx settings when using flesnet!

usage:
flib-reprogramm path/to/bitfile.bit

If programming the FPGA the first time since powerup or 
your machine does not support PCIe hot-plugging you need to reboot 
the machine after programming.


Loading/reloading the kernel driver
-----------------------------------

After rebooting you machine you need to load the kernel driver

cd misc/kernel
sudo ./reload.sh


Check if FLIB is operational
----------------------------

The script 'contrib/flib-check' should give you something like:

02:00.0 Signal processing controller [1108]: CERN/ECP/EDU Device beaf
	Subsystem: CERN/ECP/EDU Device beaf
	Control: I/O- Mem+ BusMaster+ SpecCycle- MemWINV- VGASnoop- ParErr- Stepping- SERR- FastB2B- DisINTx-
	Status: Cap+ 66MHz- UDF- FastB2B- ParErr- DEVSEL=fast >TAbort- <TAbort- <MAbort- >SERR- <PERR- INTx-
	Latency: 0
	Interrupt: pin A routed to IRQ 32
	Region 0: Memory at ca000000 (32-bit, non-prefetchable) [size=32M]
	Region 1: Memory at cc000000 (32-bit, non-prefetchable) [size=4M]
	Capabilities: [40] Power Management version 3
		Flags: PMEClk- DSI- D1- D2- AuxCurrent=0mA PME(D0+,D1+,D2+,D3hot+,D3cold-)
		Status: D0 NoSoftRst+ PME-Enable- DSel=0 DScale=0 PME-
	Capabilities: [48] MSI: Enable- Count=1/4 Maskable- 64bit+
		Address: 0000000000000000  Data: 0000
	Capabilities: [60] Express (v2) Endpoint, MSI 00
		DevCap:	MaxPayload 256 bytes, PhantFunc 0, Latency L0s <64ns, L1 unlimited
			ExtTag- AttnBtn- AttnInd- PwrInd- RBE+ FLReset-
		DevCtl:	Report errors: Correctable- Non-Fatal- Fatal- Unsupported-
			RlxdOrd+ ExtTag- PhantFunc- AuxPwr- NoSnoop+
			MaxPayload 128 bytes, MaxReadReq 512 bytes
		DevSta:	CorrErr- UncorrErr- FatalErr- UnsuppReq- AuxPwr- TransPend-
		LnkCap:	Port #0, Speed 5GT/s, Width x8, ASPM L0s, Latency L0 unlimited, L1 unlimited
			ClockPM- Surprise- LLActRep- BwNot-
		LnkCtl:	ASPM Disabled; RCB 64 bytes Disabled- Retrain- CommClk+
			ExtSynch- ClockPM- AutWidDis- BWInt- AutBWInt-
		LnkSta:	Speed 5GT/s, Width x8, TrErr- Train- SlotClk+ DLActive- BWMgmt- ABWMgmt-
		DevCap2: Completion Timeout: Range B, TimeoutDis-
		DevCtl2: Completion Timeout: 50us to 50ms, TimeoutDis-
		LnkCtl2: Target Link Speed: 5GT/s, EnterCompliance- SpeedDis-, Selectable De-emphasis: -6dB
			 Transmit Margin: Normal Operating Range, EnterModifiedCompliance- ComplianceSOS-
			 Compliance De-emphasis: -6dB
		LnkSta2: Current De-emphasis Level: -6dB, EqualizationComplete-, EqualizationPhase1-
			 EqualizationPhase2-, EqualizationPhase3-, LinkEqualizationRequest-
	Capabilities: [100 v1] Device Serial Number 00-00-00-00-00-00-00-00
	Kernel driver in use: rorcfs

Check if:
 'Kernel driver in use' shows 'rorcfs'. Otherwise reload the Kernel driver.
 'LnkSta:' shows 'Speed 5GT/s' and 'Width x8'. Otherwise the card is not running with full capabilities.
   Try to replug the card or switch to an other PCIe slot.


FAQ
===

Flesnet exits with:
"ERROR: rdma_bind_addr(port=20079) failed: Cannot assign requested
address terminate called without an active exception"

- Check if there are leftover procecces for a previous run.
- Check if 'localhost' is set properbly in /etc/hosts or
  try to use '127.0.0.1' instead of 'localhost' in the flesnet.cfg


What should I do if something went wrong?

- If flesnet crashed, exited with an exception, was stopped
  or is just not working you might need to cleanup some things.
  Try to one or more of the following things:

   Check if there are left over processes and kill them.
   Most likely there is still a 'tsclient' process.

   Remove leftover shared memories if present:
   'sudo rm /dev/shm/flesnet_*'

   Reprogramm the FLIB FPGA and reload the kernel module.


How can I check if the FLIB is installed correctly?

- See the 'Check' section in 'Preparing the FLIB'


What to do if the FLIB/PC gets unresponsible after programming
or a few minutes of use?

- Set the boot parameters 'pcie_aspm=off 'acpi=ht noapic'
- Try to disable ASPM in the BIOS settings of your host PC

My syslog/kernel log is flooded with errors like:
flip00 kernel: [  573.734102] pcieport 0000:00:01.0: AER: Corrected error received: id=0008
flip00 kernel: [  573.734113] pcieport 0000:00:01.0: PCIe Bus Error: severity=Corrected, type=Physical Layer, id=0008(Receiver ID)
flip00 kernel: [  573.734115] pcieport 0000:00:01.0:   device [8086:0e02] error status/mask=00000001/00002000
flip00 kernel: [  573.734117] pcieport 0000:00:01.0:    [ 0] Receiver Error         (First)

- Set the boot parameters 'pcie_aspm=off 'acpi=ht noapic'


Felsnet can not allocate enough memory.

- The softiwarp install script installs a configuration to /etc/security/limits.d/.
  You need to re-login after installing for these changes to take affect.
- If the problem is still present try 'sudo ulimit -l unlimited' as a workaround.


Programming the FLIB FPGA is very slow (lasts longer than 60s).

- There is an issue with the Xilinx Lab Tools.
  Try this solution http://forums.xilinx.com/t5/Design-Tools-Others/iMPACT-severe-TCK-frequency-derating-under-Linux-still-the-same/m-p/422263#M5692


The FLIB programming script reports the warning:
Warning: Chain frequency (1000000) is less than the current cable speed (6000000).
 Adjust to cable speed (1000000).
Maximum TCK operating frequency for this device chain: 1000000.

- See 'Programming the FLIB FPGA is very slow'


The PC restarts immediately after I try to shut it down.

This is an hardware issue with HTG-K7 rev 1.0 boards. It is caused by the PCIe
wake signal changing its state when the FPGA looses configuration after power down.
Workarounds:
- Unplug the power after shutting down
- Try to disable PCIe wake capability, e.g. by changing wake-on-lan BIOS settings
- Isolate the wake# pin on the PCIe connector
