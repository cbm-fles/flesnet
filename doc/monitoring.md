# Howto: Monitoring a flesnet topology

Using the monitoring library developed originaly for the CBM DCA package (TODO: link), the various flesnet binaries
provide options to periodically export performance and  usage information to `InfluxDB v1.x` or `InfluxDB v2.x`
databases (as well as syslog and similar tools, but not covered yet in this Howto).

JSON source files for some typical dashboards displaying these information in Grafana are made available in the
`contrib/grafana_dashboards` folder. \
These dashboards correspond to the ones used in the mCBM beam campaign 2022, exported as JSON and modified to use
portable data-source names instead of hashes specific to the local `Grafana to InfluxDB` configuration.

This HowTo will explain:
- the installation and configuration of recent versions of InfluxDB to be compatible with the FLESnet monitoring
- the installation and configuration of recent versions of Grafana to be compatible with the the InfluxDB setup in
  previous step
- the importation of the dashboards in Grafana
- the content and standard usage of each of the provided dashboards

Status of the Howto:
- [x] Installation procedure (02/10/2023)
  - [ ] InfluxDB v1.x
  - [x] InfluxDB v2.x
  - [x] Grafana
  - [ ] Grafana + InfluxDB v1.x
  - [x] Grafana + InfluxDB v2.x
- [ ]

Tested with
- `Influx v2.7` and `Grafana v10.1.0` (PAL, GIF++, only cri_status, 09/2023)

## Installation

### InfluxDB

## InfluxDb

1. Follow the instructions at https://docs.influxdata.com/influxdb/ \
   For the `legacy` version `v1.8` the instructions are at https://docs.influxdata.com/influxdb/v1/introduction/install/ \
   For the version `v2.x` the instructions are at https://docs.influxdata.com/influxdb/v2/install/?t=Linux \
   Currrent minor versions is `1.8.10` or `2.7`
1. Tune the options in `/etc/influxdb/influxdb.conf` \
   Here I disabled the reporting of usage data to the developper (l.15) and set the host address to
   `127.0.0.1:8086` (~l.260) in order to restrict connections to the test server to local ones.
   ```
   reporting-disabled = true
   [...]
   [http]
     [...]
     # => PAL 09/2023: allow only local connections
     bind-address = "127.0.0.1:8086"
   ```
1. Enable the InfluxDb service in the OS
   ```
   sudo -k systemctl enable --now influxdb
   systemctl status influxdb
   ```

### Grafana

1. Follow the instructions at https://grafana.com/docs/grafana/latest/setup-grafana/installation/ \
   All tests were done with the `OSS` version, either `9.5.2 OSS` or `10.1.0 OSS
1. Tune the options in `/etc/grafana/grafana.ini` \
   Here I set the host address and port to `127.0.0.1:3000` in order to restrict connections to the test server
   to local ones.
1. Enable the Grafana service in the OS
   ```
   sudo -k systemctl enable --now grafana-server.service
   systemctl status grafana-server.service
   ```


## Configuration

### InfluxDB

Standard names are needed for the databases/buckets in order to simplify/make portable the configuration of the
InfluxDB-Grafana link. We use therefore the following:
- `cri_status` for the monitoring information generated by the `cri_status` binary
- `flesnet_status` for the monitoring information generated by the `flesnet` binary
- `tsclient_status` for the monitoring information generated by the `tsclient` binary

#### `v1.x`

Create the target databases in InfluxDb with the `InfluxCLI` tool (should work in any console)
```
influx
> create database cri_status
> create database tsclient_status
> create database flesnet_status
> quit
``````

#### `v2.x`

The monitoring library uses an hard-coded organisation: `CBM`.

The creation and configuration of accesses can be done in a console, and should not require root access (but may if
another installation method was used)
```
influx org create --name CBM
influx auth create --org CBM --all-access
influx bucket create --org CBM --name cri_status
influx bucket create --org CBM --name tsclient_status
influx bucket create --org CBM --name flesnet_status
influx auth list
```
The last command allows to read the value of the token associated to CBM in case you forgot to write it down/save it
somewhere.

### Grafana

Standard names are needed for the connection in order to simplify/make portable the configuration of the
dashboards. We use therefore the following:
- `InfluxDb-CriStatus` for `cri_status`
- `InfluxDb-FlesnetStatus` for `flesnet_status`
- `InfluxDb-TsclientStatus` for `tsclient_status`

#### Admin account setup (only first connection)
1. Connect to `https://localhost:3000` in your favorite web browser (tested with `Firefox >= 102``)
1. Connect as `admin:admin` and set the new admin password when requested


#### Natel discrete Plugin
This plugin is Signed/verified and needed for the `CRI status` dashboard

1. Connect as `admin` to Grafana
1. Click on the 3 bars in the top left to open the menu and go to `Administration`
1. Click on `Plugins`
1. In the search options bar click on `State > All`
1. Enter `Discrete` in the search bar
1. Click the one made by Natel Energy
1. Click `Install` in the top right


#### Connection to `InfluxDB v1.x`

1. Connect as `admin` to Grafana
1. Click on the 3 bars on the top left to open the menu and go to `Connections`\
   => You should end up in `Add new connections`
1. In the search bar enter `influx` and select `InfluxDB` (not `Influx Admin`!)
1. Click `Add new data source`
1. Rename to `InfluxDb-CriStatus`
1. In `Http` block `Url`, enter explicitely `http://localhost:8086/` or `http://127.0.0.1:8086`
1. Down in the page, in database enter `cri_status`
1. Click on `Save and Test` at the bottom of the page (try swapping localhost for 127.0.0.1 if test fails)
1. Repeat for `flesnet_status` (`InfluxDb-FlesnetStatus`) and `tsclient_status` (`InfluxDb-TsclientStatus`)

#### Connection to `InfluxDB v2.x`

1. Connect as `admin` to Grafana
1. Click on the 3 bars on the top left to open the menu and go to `Connections`\
   => You should end up in `Add new connections`
1. In search bar, type `influx` and pick `InfluxDb`
1. Click `Add new data source`
1. Rename to `InfluxDb-CriStatus`
1. In `Http` block `Url` field, enter explicitely `http://localhost:8086/`
1. In `Custom Http Header` block click `+ Add Header`
   1. In `Header` field enter `Authorization`
   1. In `Value` field enter `Token <value read while configuring Influx v2>`
1. In `InfluxDB Details` block
   1. In "database" field, enter the name of the bucket: `cri_status`
   1. In `HTTP method` field, pick `GET`
1. Click on `Save and Test` at the bottom of the page
1. Repeat for `flesnet_status` (`InfluxDb-FlesnetStatus`) and `tsclient_status` (`InfluxDb-TsclientStatus`)

#### Importation of the dashboards

1. Connect as `admin` to Grafana
1. Click on the 3 bars on the top left to open the menu and go to `Dashboards`
1. Click on `New` then `import`
1. Either select `<flesnet>/contrib/grafana_dashboards/cri-status_portable.json` in `Import dashboard from file` \
   or copy its content to the field in `Import via panel json`
1. Click on `Load`
1. Check the info displayed and click on `Import`
1. Repeat for the 3 other `*_portable.json` files

## Usage

### Binaries options

The options should either be given in the call to the binary in the console, added to its line in the `fles.cfg` file
or added to its options in the `flesctl` configuration.

#### `InfluxDB v1.x`

The default options for the database address and port (only `-m` option should be enough if working on the mFLES login
node. \
If working  on another node with InfluxDB  installed locally as in this HowTo, please use the URI from the follwoing
commands.
1. CRI status (maybe add in crontab to start it at boot?)
   ```bash
   cri_status -m influx1:localhost:8086:cri_status
   ```
   => This should print a line with "Starting measurements", then just let it run silently
1. flesnet: add following option in your command
   ```bash
   flesnet  [...] -m influx1:localhost:8086:flesnet_status
   ```
1. tsclient: add following option in your command (eventually in your flesnet config file!)
   ```bash
   tsclient [...] -m influx1:localhost:8086:tsclient_status
   ```


#### `InfluxDB v2.x`

1. CRI status (maybe add in crontab to start it at boot?)
   ```bash
   export CBM_INFLUX_TOKEN=<value read while configuring Influx v2>
   cri_status -m influx2:localhost:8086:cri_status:
   ```
   => This should print a line with "Starting measurements", then just let it run silently
1. flesnet: add following export in your console and option in your command
   ```bash
   export CBM_INFLUX_TOKEN=<value read while configuring Influx v2>
   flesnet  [...] -m influx2:localhost:8086:flesnet_status:
   ```
1. tsclient: add following export in your console and option in your command
   ```bash
   export CBM_INFLUX_TOKEN=<value read while configuring Influx v2>
   tsclient [...] -m influx2:localhost:8086:tsclient_status:
   ```

### Dashboards description and usage

#### Cri Status

Rough back-pressure monitoring with overview of all Entry Nodes and CRIs (or a selection of EN(s) + PCI-slot(s))

TODO

#### CRI Backpressure Detail

Detailled back-pressure monitoring for a single selected EN and a choice of its CRIs (from 1 to all)

TODO

#### FLESNET Overview

Main monitoring panel: total data rate, data rate per system, microslice-rate per link, timeslice building buffers usage

TODO

#### FLESnet Data Rates Details

TODO
